name: Intake Issue to PR

on:
  issues:
    types: [opened, edited]

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare workspace
        run: |
          mkdir -p apps/analyzer/BR_Data/intake

      - name: Check labels and extract attachments (links in issue body)
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            // Only proceed if the Issue has the 'intake' label
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            const hasIntake = labels.includes('intake');
            core.setOutput('hasIntake', hasIntake ? 'true' : 'false');
            const body = context.payload.issue.body || '';
            const urls = [...body.matchAll(/https?:\/\/\S+/g)].map(m => m[0]);
            core.setOutput('urls', JSON.stringify(urls));

      - name: Download attachments
        if: steps.extract.outputs.hasIntake == 'true' && steps.extract.outputs.urls != '[]'
        run: |
          node -e "
          const fs = require('fs');
          const https = require('https');
          const urls = JSON.parse(process.env.URLS);
          function dl(u, dest){
            return new Promise((resolve,reject)=>{
              const file = fs.createWriteStream(dest);
              https.get(u, res => {
                if (res.statusCode !== 200) return reject(new Error('HTTP '+res.statusCode));
                res.pipe(file);
                file.on('finish', ()=>file.close(resolve));
              }).on('error', reject);
            });
          }
          (async()=>{
            for(const u of urls){
              const name = u.split('/').pop().split('?')[0];
              if(!name.endsWith('.json')) continue;
              const dest = `apps/analyzer/BR_Data/intake/${name}`;
              await dl(u, dest);
              console.log('Downloaded', dest);
            }
          })().catch(e=>{console.error(e); process.exit(1);});
          "
        env:
          URLS: ${{ steps.extract.outputs.urls }}

      - name: Validate downloaded JSON
        if: steps.extract.outputs.hasIntake == 'true'
        run: |
          for f in $(ls apps/analyzer/BR_Data/intake/*.json 2>/dev/null); do
            node -e "JSON.parse(require('fs').readFileSync('$f','utf8'))" || { echo "JSON parse failed: $f"; exit 1; }
          done

      - name: Create branch and commit
        if: steps.extract.outputs.hasIntake == 'true'
        id: commit
        run: |
          BRANCH="intake/issue-${{ github.event.issue.number }}"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout -b "$BRANCH"
          git add apps/analyzer/BR_Data/intake/*.json || true
          git commit -m "Intake: Issue #${{ github.event.issue.number }} to BR_Data" || echo "No files to commit"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Push branch
        if: steps.extract.outputs.hasIntake == 'true'
        run: |
          git push --set-upstream origin "${{ steps.commit.outputs.branch }}" || echo "No branch pushed (no files)"

      - name: Open PR
        if: steps.extract.outputs.hasIntake == 'true' && steps.commit.outputs.branch != ''
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.BRANCH;
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Intake: Issue #${context.payload.issue.number}`,
              head: branch,
              base: 'dev-branch',
              body: `Automated PR from Issue #${context.payload.issue.number}.\n\nEvent: ${context.payload.issue.title}\n\nLinks: ${context.payload.issue.html_url}`
            });
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['pending-validation']
            });
          result-encoding: string
        env:
          BRANCH: ${{ steps.commit.outputs.branch }}
